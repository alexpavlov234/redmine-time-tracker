<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redmine Time Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="dist/css/main.min.css">
    <link rel="icon" href="src/images/favicon.png" type="image/x-icon">
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container"></div>

    <div id="app" class="container py-4">
        <!-- Global Error Container -->
        <div id="global-error-container"></div>

        <header class="text-center">
            <h1 class="text-white mb-3">Redmine Time Tracker</h1>
            <nav>
                <div class="d-flex justify-content-center gap-3 position-relative">
                    <div class="d-flex justify-content-center gap-3 position-relative">
                        <a href="#" id="nav-tracker" class="nav-link active text-decoration-none">
                            <i class="fa-solid fa-clock me-2"></i>Tracker
                        </a>
                        <a href="#" id="nav-logged-time" class="nav-link text-decoration-none">
                            <i class="fa-solid fa-history me-2"></i>Logged Time
                        </a>
                        <a href="#" id="nav-settings" class="nav-link text-decoration-none">
                            <i class="fa-solid fa-cog me-2"></i>Settings
                        </a>
                    </div>
                    <!-- Theme Toggle Button -->
                    <div class="position-absolute end-0">
                        <button class="btn btn-sm" type="button" id="theme-toggle" title="Toggle theme">
                            <i class="fa-solid fa-circle-half-stroke" id="theme-icon"></i>
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <div id="tracker-page">
            <!-- Sticky Active Timer Bar -->
            <div id="active-timer-bar" class="sticky-timer-bar">
                <div id="config-prompt" class="alert alert-info mb-0" style="display: none;">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    Please configure your Redmine URL and API Key in the <a href="#" id="prompt-link-to-settings"
                        class="alert-link fw-semibold">Settings</a>
                    page to get started.
                </div>
                <div id="no-task-prompt" class="empty-timer-state" style="display: none;">
                    <div class="empty-timer-content">
                        <i class="fa-solid fa-arrow-down empty-arrow"></i>
                        <span>Add a task from <strong>Watched Issues</strong> or the <strong>Add Task</strong> form to
                            start tracking</span>
                    </div>
                </div>
                <div id="timer-bar-content" class="timer-bar-content" style="display: none;">
                    <div class="timer-task-info">
                        <span id="project-display" class="timer-project"></span>
                        <span id="task-display" class="timer-task"></span>
                        <span id="activity-display" class="timer-activity" style="display: none;"></span>
                        <!-- Keep hidden selects for data storage -->
                        <select id="project-select" style="display: none;"></select>
                        <select id="task-select" style="display: none;"></select>
                        <select id="activity-select" style="display: none;">
                            <option value="">-- Loading activities --</option>
                        </select>
                        <input type="hidden" id="project-input">
                        <input type="hidden" id="task-input">
                        <div id="project-list" class="autocomplete-items" style="display: none;"></div>
                        <div id="task-list" class="autocomplete-items" style="display: none;"></div>
                    </div>
                    <div id="time-display" class="timer-display">00:00:00</div>
                    <div id="timer-controls" class="timer-controls">
                        <button id="start-btn" class="btn btn-success btn-timer" title="Start">
                            <i class="fa-solid fa-play"></i>
                        </button>
                        <button id="pause-btn" class="btn btn-warning btn-timer" disabled title="Pause">
                            <i class="fa-solid fa-pause"></i>
                        </button>
                        <button id="stop-btn" class="btn btn-danger btn-timer" disabled title="Stop & Submit">
                            <i class="fa-solid fa-stop"></i>
                        </button>
                    </div>
                </div>
                <div id="activity-display-container" style="display: none;"></div>
            </div>

            <main class="row g-4 mt-2">
                <!-- Left Column: Quick Add Panel -->
                <section id="quick-add-panel" class="col-lg-5">
                    <!-- Watched Issues - Collapsible -->
                    <div class="card mb-3" id="watched-issues-card">
                        <div class="card-header accordion-header" data-bs-toggle="collapse"
                            data-bs-target="#watched-issues-collapse" aria-expanded="true">
                            <h5 class="card-title mb-0 d-flex justify-content-between align-items-center">
                                <span class="d-flex align-items-center gap-2">
                                    <i class="fa-solid fa-eye text-primary"></i>
                                    Watched Issues
                                    <i class="fa-solid fa-chevron-down collapse-icon"></i>
                                </span>
                                <button id="refresh-watched-btn" class="btn btn-sm btn-outline-secondary"
                                    title="Refresh" onclick="event.stopPropagation();">
                                    <i class="fa-solid fa-sync-alt"></i>
                                </button>
                            </h5>
                        </div>
                        <div id="watched-issues-collapse" class="collapse show">
                            <div class="card-body pt-0">
                                <p class="text-muted small mb-2">Click any issue to add it to your queue</p>
                                <div id="watched-issues-list" class="watched-issues-container">
                                    <div class="text-center text-muted py-2">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Add Form - Collapsible -->
                    <div class="card" id="add-task-card">
                        <div class="card-header accordion-header" data-bs-toggle="collapse"
                            data-bs-target="#add-task-collapse" aria-expanded="true">
                            <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                                <i class="fa-solid fa-plus-circle text-primary"></i>
                                Add Task Manually
                                <i class="fa-solid fa-chevron-down collapse-icon"></i>
                            </h5>
                        </div>
                        <div id="add-task-collapse" class="collapse show">
                            <div class="card-body">
                                <form id="todo-form">
                                    <div class="mb-3">
                                        <label for="todo-project-input" class="form-label fw-medium">Project</label>
                                        <div class="autocomplete-container">
                                            <input type="text" id="todo-project-input" placeholder="Search projects..."
                                                class="form-control form-control-sm" autocomplete="off">
                                            <div id="todo-project-list" class="autocomplete-items"></div>
                                        </div>
                                        <select id="todo-project-select" class="form-select form-select-sm"
                                            style="display: none;">
                                            <option value="">-- Select a project --</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="todo-task-input" class="form-label fw-medium">Task</label>
                                        <div class="autocomplete-container">
                                            <input type="text" id="todo-task-input" placeholder="Select a project first"
                                                class="form-control form-control-sm" autocomplete="off" disabled>
                                            <div id="todo-task-list" class="autocomplete-items"></div>
                                        </div>
                                        <select id="todo-task-select" class="form-select form-select-sm"
                                            style="display: none;" disabled>
                                            <option value="">-- Select a task --</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="todo-activity-select" class="form-label fw-medium">Activity</label>
                                        <select id="todo-activity-select" class="form-select form-select-sm">
                                            <option value="">-- Loading activities --</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="todo-note-input" class="form-label fw-medium">Note
                                            (optional)</label>
                                        <input type="text" id="todo-note-input" placeholder="Add a personal note..."
                                            class="form-control form-control-sm">
                                    </div>
                                    <button id="add-to-queue-btn" class="btn btn-primary w-100">
                                        <i class="fa-solid fa-plus"></i>
                                        Add to Queue
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Right Column: Work Queue -->
                <aside id="sidebar" class="col-lg-7">
                    <div class="card" id="work-queue-card">
                        <div class="card-body">
                            <h5 class="card-title d-flex justify-content-between align-items-center">
                                <span><i class="fa-solid fa-layer-group text-primary"></i> Work Queue</span>
                                <span id="queue-count" class="badge bg-primary">0</span>
                            </h5>
                            <p class="text-muted small mb-3">Drag to reorder. First task is active when timer starts.
                            </p>
                            <ul id="todo-list" class="list-unstyled work-queue-list"></ul>
                        </div>
                    </div>

                    <!-- Performed Tasks - Below Queue -->
                    <div class="card mt-3" id="activity-card">
                        <div class="card-header accordion-header" data-bs-toggle="collapse"
                            data-bs-target="#performed-tasks-collapse" aria-expanded="false">
                            <h5 class="card-title mb-0 d-flex align-items-center gap-2">
                                <i class="fa-solid fa-list-check text-primary"></i>
                                Performed Tasks
                                <i class="fa-solid fa-chevron-down collapse-icon"></i>
                            </h5>
                        </div>
                        <div id="performed-tasks-collapse" class="collapse">
                            <div class="card-body">
                                <div id="activity-form" class="d-flex gap-2 mb-3">
                                    <input type="text" id="activity-input" placeholder="What task are you performing?"
                                        class="form-control form-control-sm" disabled>
                                    <button id="add-activity-btn" class="btn btn-outline-primary" disabled>
                                        <i class="fa-solid fa-plus"></i>
                                        Add
                                    </button>
                                </div>
                                <ul id="activity-list" class="list-unstyled"
                                    style="max-height: 300px; overflow-y: auto;"></ul>
                            </div>
                        </div>
                    </div>
                </aside>
            </main>
        </div>

        <div id="logged-time-page" class="container" style="display: none;">
            <div class="row g-2">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title" id="last-logged-day-title">Last Logged Day</h5>
                            <div id="last-day-projects-summary" class="mb-3"></div>
                            <ul id="last-log" class="list-group list-group-flush"></ul>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <strong>Total:</strong>
                            <span id="last-log-total-time" class="fw-bold">0h 0m</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Today</h5>
                            <div id="today-projects-summary" class="mb-3"></div>
                            <ul id="today-log" class="list-group list-group-flush"></ul>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <strong>Total:</strong>
                            <span id="today-total-time" class="fw-bold">0h 0m</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="settings-page" class="container" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fa-solid fa-gears text-primary"></i>
                        Redmine Configuration
                    </h5>
                    <form id="settings-form">
                        <div class="mb-3">
                            <label for="redmine-url" class="form-label">Redmine URL</label>
                            <input type="url" id="redmine-url" class="form-control form-control-sm"
                                placeholder="https://your.redmine.com">
                        </div>
                        <div class="mb-3">
                            <label for="redmine-api-key" class="form-label">API Key</label>
                            <input type="password" id="redmine-api-key" class="form-control form-control-sm"
                                placeholder="Enter your Redmine API key">
                        </div>
                        <div class="mb-3" style="display: none;">
                            <label for="billable-field-id" class="form-label">"Billable" Custom Field ID
                                (Auto-detected)</label>
                            <input type="number" id="billable-field-id" class="form-control form-control-sm"
                                placeholder="Auto-detected from your Redmine custom fields" readonly>
                        </div>
                        <div id="settings-controls" class="d-flex gap-3 mb-3">
                            <button id="save-settings-btn" class="btn btn-primary">
                                <i class="fa-solid fa-save"></i>
                                Save Settings
                            </button>
                            <button id="test-connection-btn" class="btn btn-secondary">
                                <i class="fa-solid fa-plug"></i>
                                Test Connection
                            </button>
                        </div>
                        <div id="connection-status"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="summary-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="summary-form">
                    <div class="modal-header">
                        <h5 class="modal-title">Submit Time Entry</h5>
                        <button type="button" id="close-modal" class="btn-close" aria-label="Close"
                            data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Total Time:</strong> <span id="summary-time"></span></p>
                        <div class="mb-3">
                            <label for="summary-details" class="form-label fw-medium">Comments</label>
                            <textarea id="summary-details" rows="4" class="form-control form-control-sm"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="summary-activity-select" class="form-label fw-medium">Activity</label>
                            <select id="summary-activity-select" class="form-select form-select-sm">
                                <option value="">-- Loading activities --</option>
                            </select>
                        </div>

                        <hr />

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="billable-checkbox-simple" checked>
                                <label class="form-check-label fw-medium" for="billable-checkbox-simple">
                                    Billable
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="change-status-checkbox">
                                <label class="form-check-label fw-medium" for="change-status-checkbox">
                                    Change issue status after submission
                                </label>
                            </div>
                            <div id="status-change-container" class="mt-2" style="display: none;">
                                <select id="issue-status-select" class="form-select form-select-sm"></select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="submit-btn" class="btn btn-primary">
                            <i class="fa-solid fa-paper-plane"></i>
                            Submit to Redmine
                        </button>
                    </div>
                    <div id="modal-status" class="mx-3 mb-3"></div>
                </form>
            </div>
        </div>
    </div>

    <div id="first-activity-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">What is your first performed task?</h5>
                    <button type="button" id="close-first-activity-modal" class="btn-close" aria-label="Close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="first-activity-input" class="form-label fw-medium">Performed task
                            description</label>
                        <input type="text" id="first-activity-input" class="form-control form-control-sm"
                            placeholder="e.g., Investigating bug #123">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="start-with-activity-btn" class="btn btn-primary">
                        <i class="fa-solid fa-play"></i>
                        Start Tracking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="src/main.ts" type="module"></script>
</body>

</html>